{% extends "base.html" %}
{% load static %}

{% block title %}Depósito - TotalEnergies{% endblock %}

{% block content %}
<div class="deposit-container">
    <div class="jackpay-header">
        <div class="logo-box">
            <i class="fas fa-shield-alt"></i> <span>JackPay Security</span>
        </div>
    </div>

    <div class="stepper">
        <div class="step-item">
            <div class="circle active" id="circle-1">1</div>
            <span>Valor</span>
        </div>
        <div class="line"></div>
        <div class="step-item">
            <div class="circle" id="circle-2">2</div>
            <span>Método</span>
        </div>
        <div class="line"></div>
        <div class="step-item">
            <div class="circle" id="circle-3">3</div>
            <span>Envio</span>
        </div>
    </div>

    {% if deposit_success %}
        <div class="success-screen">
            <div class="success-icon"><i class="fas fa-check"></i></div>
            <h2>Solicitação Enviada!</h2>
            <p>O seu depósito será confirmado em um período de 5 a 30 minutos.</p>
            <a href="{% url 'menu' %}" class="btn-main">Voltar ao Início</a>
        </div>
    {% else %}
        <form id="deposit-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="{{ form.amount.name }}" id="id_amount" value="">
            <input type="hidden" name="payment_method" id="id_payment_method" value="">

            <div id="step-1" class="step-content">
                <div class="balance-card">
                    <p><i class="fas fa-wallet"></i> Seu Saldo Atual</p>
                    <h3>Kz {{ user.available_balance }}</h3>
                </div>

                <div class="amount-section">
                    <label>Valor do Depósito</label>
                    <div class="input-wrapper">
                        <span class="currency-tag">Kz</span>
                        <input type="number" id="manual-amount" placeholder="0.00" min="3000">
                    </div>

                    <div class="grid-amounts">
                        {% for deposit_value in level_deposits_list %}
                            <button type="button" class="amount-btn" data-value="{{ deposit_value }}">{{ deposit_value }}</button>
                        {% endfor %}
                    </div>
                </div>

                <div class="info-rules">
                    <h4><i class="fas fa-info-circle"></i> Regras Importantes</h4>
                    <ul>
                        <li><span class="dot">1</span> Valor mínimo: 3.000 Kz.</li>
                        <li><span class="dot">2</span> Anexe sempre o comprovativo oficial.</li>
                    </ul>
                </div>
                <button type="button" class="btn-main" id="to-step-2" disabled style="margin-top: 20px;">Continuar</button>
            </div>

            <div id="step-2" class="step-content" style="display: none;">
                <h4 class="step-title">Escolha como deseja pagar:</h4>
                <div class="method-list">
                    <button type="button" class="method-option-btn" data-method="bank">
                        <i class="fas fa-university"></i> Coordenadas Bancárias (KZ)
                    </button>
                    <button type="button" class="method-option-btn" data-method="pix">
                        <i class="fab fa-pix" style="color: #32bcad;"></i> Pagamento via PIX (BRL)
                    </button>
                    <button type="button" class="method-option-btn" data-method="trc20">
                        <i class="fas fa-coins" style="color: #ff9f43;"></i> Carteira TRC20 (USDT)
                    </button>
                </div>

                <div id="sub-step-bank" class="method-details" style="display:none; margin-top:20px;">
                    <p class="label-small">Selecione o Banco:</p>
                    <div class="bank-list">
                        {% for bank in platform_bank_details %}
                            <button type="button" class="bank-option-btn" data-bank-id="{{ bank.id }}" data-info="{{ bank.bank_name }}|{{ bank.account_holder_name }}|{{ bank.IBAN }}">
                                {{ bank.bank_name }}
                            </button>
                        {% endfor %}
                    </div>
                </div>

                <div id="sub-step-pix" class="method-details" style="display:none; margin-top:20px;">
                    <div class="bank-info-card" style="border-left-color: #32bcad;">
                        <p><strong>Chave PIX:</strong> <span id="pix-key">financeiro@empresa.com</span></p>
                        <p><strong>Nome:</strong> Administrador Geral</p>
                        <button type="button" class="copy-btn-small" onclick="copyValue('financeiro@empresa.com')">Copiar Chave PIX</button>
                    </div>
                </div>

                <div id="sub-step-trc20" class="method-details" style="display:none; margin-top:20px;">
                    <div class="bank-info-card" style="border-left-color: #ff9f43;">
                        <p><strong>Endereço TRC20:</strong></p>
                        <code id="trc-addr" style="word-break: break-all; font-size: 11px;">TY987shdashd8234JHDSFSDF923</code>
                        <br><br>
                        <button type="button" class="copy-btn-small" onclick="copyValue('TY987shdashd8234JHDSFSDF923')">Copiar Endereço</button>
                    </div>
                </div>

                <button type="button" class="btn-main" id="to-step-3" style="margin-top:20px" disabled>Confirmar Método</button>
            </div>

            <div id="step-3" class="step-content" style="display: none;">
                <div class="summary-box">
                    <p>Valor: <strong id="summary-amount"></strong></p>
                    <p>Método: <strong id="summary-method"></strong></p>
                </div>

                <p class="upload-label">Envie o comprovativo abaixo:</p>
                <div class="upload-box" onclick="document.getElementById('file-upload').click()">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <input type="file" name="{{ form.proof_of_payment.name }}" id="file-upload" hidden accept="image/*" required>
                    <p id="file-name">Toque para selecionar imagem</p>
                </div>

                <div class="info-group" style="margin-top: 15px;">
                    <label>Nome do Depositante / Titular</label>
                    <input type="text" name="payer_name" placeholder="Nome completo" class="simple-input" required>
                </div>

                <button type="submit" class="btn-main" style="background: #2e7d32; margin-top: 15px;">Finalizar Depósito</button>
            </div>
        </form>
    {% endif %}
</div>

<style>
    :root { --total-blue: #0056b3; --total-green: #2e7d32; --bg-white: #ffffff; }
    body { font-family: 'Poppins', sans-serif; background: #f8f9fa; }
    .deposit-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; padding: 20px; }
    
    /* Stepper */
    .stepper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
    .circle { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; color: #aaa; }
    .circle.active { border-color: var(--total-blue); color: var(--total-blue); background: #eef2ff; }
    .circle.checked { background: var(--total-blue); color: white; border-color: var(--total-blue); }
    .line { flex: 1; height: 2px; background: #eee; margin: 0 10px; }

    /* Buttons & Options */
    .method-option-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; border-radius: 12px; background: white; text-align: left; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .method-option-btn.active { border: 2px solid var(--total-blue); background: #f0f7ff; }
    .bank-option-btn { padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 5px; background: white; cursor: pointer; }
    .bank-option-btn.active { background: var(--total-blue); color: white; }

    .bank-info-card { padding: 15px; border-left: 5px solid var(--total-blue); background: #f9f9f9; border-radius: 8px; margin-bottom: 15px; }
    .copy-btn-small { background: #eee; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 5px; }
    
    .amount-section { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 15px; }
    .input-wrapper { display: flex; align-items: center; border: 2px solid #eee; border-radius: 10px; padding: 10px; margin: 10px 0; }
    .input-wrapper input { border: none; width: 100%; font-size: 18px; outline: none; }
    .grid-amounts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .amount-btn { padding: 10px; border: 1px solid #eee; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .amount-btn.active { background: var(--total-blue); color: white; }

    .upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; }
    .btn-main { width: 100%; padding: 15px; border-radius: 10px; border: none; background: var(--total-blue); color: white; font-weight: bold; cursor: pointer; }
    .btn-main:disabled { background: #ccc; }
    .simple-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .summary-box { background: #e8f5e9; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const amountHidden = document.getElementById('id_amount');
        const methodHidden = document.getElementById('id_payment_method');
        const manualInput = document.getElementById('manual-amount');
        const next1 = document.getElementById('to-step-2');
        const next2 = document.getElementById('to-step-3');

        // Navegação de Valor
        manualInput.addEventListener('input', () => {
            amountHidden.value = manualInput.value;
            next1.disabled = manualInput.value < 3000;
        });

        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                manualInput.value = btn.dataset.value;
                amountHidden.value = btn.dataset.value;
                next1.disabled = false;
            });
        });

        next1.addEventListener('click', () => {
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
            document.getElementById('circle-1').classList.add('checked');
            document.getElementById('circle-1').innerHTML = "✓";
            document.getElementById('circle-2').classList.add('active');
        });

        // Seleção de Método
        document.querySelectorAll('.method-option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.method-option-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const method = btn.dataset.method;
                methodHidden.value = method;
                
                // Mostrar campos específicos
                document.querySelectorAll('.method-details').forEach(d => d.style.display = 'none');
                if(method === 'bank') document.getElementById('sub-step-bank').style.display = 'block';
                if(method === 'pix') document.getElementById('sub-step-pix').style.display = 'block';
                if(method === 'trc20') document.getElementById('sub-step-trc20').style.display = 'block';
                
                next2.disabled = (method === 'bank'); // Se for banco, precisa escolher o banco primeiro
                if(method !== 'bank') next2.disabled = false;
            });
        });

        // Se escolher banco específico
        document.querySelectorAll('.bank-option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.bank-option-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                next2.disabled = false;
            });
        });

        next2.addEventListener('click', () => {
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-3').style.display = 'block';
            document.getElementById('circle-2').classList.add('checked');
            document.getElementById('circle-2').innerHTML = "✓";
            document.getElementById('circle-3').classList.add('active');
            
            document.getElementById('summary-amount').innerText = amountHidden.value + " KZ";
            document.getElementById('summary-method').innerText = methodHidden.value.toUpperCase();
        });

        document.getElementById('file-upload').addEventListener('change', function() {
            document.getElementById('file-name').innerText = this.files[0] ? this.files[0].name : "Selecionado";
        });
    });

    function copyValue(val) {
        navigator.clipboard.writeText(val);
        alert("Copiado: " + val);
    }
</script>
{% endblock %}
