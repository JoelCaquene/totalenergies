{% extends "base.html" %}
{% load static %}

{% block title %}Depósito - TotalEnergies{% endblock %}

{% block content %}
<div class="deposit-container">
    <div class="jackpay-header">
        <div class="logo-box">
            <i class="fas fa-shield-alt"></i> <span>JackPay Security</span>
        </div>
    </div>

    <div class="stepper">
        <div class="step-item">
            <div class="circle active" id="circle-1">1</div>
            <span class="step-label">Método</span>
        </div>
        <div class="line"></div>
        <div class="step-item">
            <div class="circle" id="circle-2">2</div>
            <span class="step-label">Dados</span>
        </div>
        <div class="line"></div>
        <div class="step-item">
            <div class="circle" id="circle-3">3</div>
            <span class="step-label">Envio</span>
        </div>
    </div>

    {% if deposit_success %}
        <div class="success-screen">
            <div class="success-icon"><i class="fas fa-check"></i></div>
            <h2>Solicitação Enviada!</h2>
            <p>Aguarde a confirmação em 5 a 30 minutos.</p>
            <a href="{% url 'home' %}" class="btn-main">Voltar ao Início</a>
        </div>
    {% else %}
        <form id="deposit-form" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <input type="hidden" name="amount" id="id_amount">
            <input type="hidden" name="payment_method" id="id_payment_method" value="bank">
            <input type="hidden" name="selected_bank" id="id_selected_bank">

            <div id="step-1" class="step-content">
                <div class="balance-card">
                    <p><i class="fas fa-wallet"></i> Saldo Disponível</p>
                    <h3>Kz {{ user.available_balance|default:"0.00" }}</h3>
                </div>

                <div class="main-card">
                    <label class="input-label">Valor do Depósito</label>
                    <div class="input-wrapper">
                        <span class="currency-tag" id="currency-label">Kz</span>
                        <input type="number" id="manual-amount" placeholder="0.00" inputmode="decimal">
                    </div>

                    <p class="label-small">Escolha o Método de Pagamento</p>
                    <div class="method-grid">
                        <div class="method-card active" data-method="bank" data-curr="Kz">
                            <div class="method-icon bank-icon"><i class="fas fa-university"></i></div>
                            <span class="method-name">Banco</span>
                        </div>
                        <div class="method-card" data-method="pix" data-curr="R$">
                            <div class="method-icon pix-icon"><i class="fas fa-bolt"></i></div>
                            <span class="method-name">PIX</span>
                        </div>
                        <div class="method-card" data-method="trc20" data-curr="USDT">
                            <div class="method-icon crypto-icon"><i class="fas fa-coins"></i></div>
                            <span class="method-name">USDT</span>
                        </div>
                    </div>
                </div>

                <div class="info-rules">
                    <h4><i class="fas fa-info-circle"></i> Regras de Depósito</h4>
                    <ul>
                        <li><span class="dot">1</span> Mínimo: 10.000 Kz / 50 R$ / 10 USDT.</li>
                        <li><span class="dot">2</span> Use apenas contas oficiais listadas.</li>
                        <li><span class="dot">3</span> O comprovativo deve estar legível.</li>
                    </ul>
                </div>
                
                <button type="button" class="btn-main" id="to-step-2" disabled>Continuar</button>
            </div>

            <div id="step-2" class="step-content" style="display: none;">
                <h4 class="step-title">Selecione a conta de destino</h4>
                <div class="bank-list">
                    {% for bank in platform_bank_details %}
                        <button type="button" class="bank-option-btn" data-bank-id="{{ forloop.counter }}">
                            <i class="fas fa-university"></i> 
                            <span>{{ bank.bank_name }}</span>
                        </button>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main" id="to-step-3" disabled>Ver Dados de Pagamento</button>
            </div>

            <div id="step-3" class="step-content" style="display: none;">
                <div class="bank-details-wrapper">
                    {% for bank in platform_bank_details %}
                        <div id="details-{{ forloop.counter }}" class="bank-info-card" style="display: none;">
                            <div class="info-group">
                                <label>Destino</label>
                                <input type="text" value="{{ bank.bank_name }}" readonly class="copyable-input">
                            </div>
                            <div class="info-group">
                                <label>Titular</label>
                                <input type="text" value="{{ bank.account_holder_name }}" readonly class="copyable-input">
                            </div>
                            <div class="info-group">
                                <label>IBAN / Carteira / Chave</label>
                                <div class="copy-box">
                                    <input type="text" value="{{ bank.IBAN }}" id="iban-{{ forloop.counter }}" readonly>
                                    <button type="button" onclick="copyText('iban-{{ forloop.counter }}')"><i class="far fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>Valor exato a enviar</label>
                                <div class="value-highlight">
                                    <input type="text" class="display-final-amount" readonly>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main" id="to-step-4">Já realizei o pagamento</button>
            </div>

            <div id="step-4" class="step-content" style="display: none;">
                <div class="main-card">
                    <p class="upload-label">Anexe o comprovativo</p>
                    <div class="upload-box" onclick="document.getElementById('file-upload').click()">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <input type="file" name="proof_of_payment" id="file-upload" hidden accept="image/*">
                        <span id="file-name">Clique para selecionar</span>
                    </div>
                    
                    <div class="info-group" style="margin-top: 20px;">
                        <label>Nome no Comprovativo</label>
                        <input type="text" name="payer_name" id="id_payer_name" placeholder="Ex: Nome do Titular" class="simple-input">
                    </div>
                </div>

                <button type="submit" class="btn-main btn-final">Finalizar Depósito</button>
            </div>
        </form>
    {% endif %}
</div>

<style>
    /* RESET E BASE */
    :root { --blue: #0056b3; --green: #2e7d32; --light-bg: #f8f9fa; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    .deposit-container { width: 100%; max-width: 450px; margin: 0 auto; padding: 12px; overflow-x: hidden; }

    /* HEADER & STEPPER */
    .jackpay-header { text-align: center; margin: 10px 0 20px; }
    .logo-box { background: #eef2ff; padding: 6px 20px; border-radius: 50px; color: var(--blue); font-weight: bold; border: 1px solid #dbeafe; font-size: 14px; }
    
    .stepper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; padding: 0 10px; }
    .step-item { display: flex; flex-direction: column; align-items: center; z-index: 2; }
    .circle { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #999; font-size: 12px; transition: 0.3s; }
    .circle.active { border-color: var(--blue); color: var(--blue); background: #fff; transform: scale(1.1); }
    .circle.checked { background: var(--blue); color: white; border-color: var(--blue); }
    .step-label { font-size: 10px; margin-top: 4px; color: #666; font-weight: 600; }
    .line { flex-grow: 1; height: 2px; background: #ddd; margin-bottom: 15px; }

    /* CARDS */
    .balance-card { background: linear-gradient(135deg, var(--blue), #003a7a); color: white; padding: 18px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,86,179,0.2); }
    .balance-card h3 { margin: 5px 0 0; font-size: 22px; }
    .main-card { background: white; border: 1px solid #edf2f7; border-radius: 16px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }

    /* INPUTS */
    .input-label { font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 8px; display: block; }
    .input-wrapper { display: flex; align-items: center; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 20px; }
    .currency-tag { font-weight: 800; color: var(--blue); padding-right: 12px; border-right: 2px solid #cbd5e0; }
    .input-wrapper input { border: none; background: transparent; width: 100%; padding-left: 12px; font-size: 20px; font-weight: 700; outline: none; color: #2d3748; }

    /* GRID DE MÉTODOS */
    .method-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .method-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 5px; text-align: center; cursor: pointer; transition: 0.2s; background: white; }
    .method-card.active { border-color: var(--blue); background: #f0f7ff; border-width: 2px; }
    .method-icon { font-size: 18px; margin-bottom: 6px; }
    .bank-icon { color: #2b6cb0; }
    .pix-icon { color: #32bcad; }
    .crypto-icon { color: #f59e0b; }
    .method-name { font-size: 11px; font-weight: 700; color: #4a5568; }

    /* REGRAS */
    .info-rules { background: #fff5f5; border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid #fed7d7; }
    .info-rules h4 { font-size: 13px; color: #c53030; margin: 0 0 10px; }
    .info-rules ul { padding: 0; margin: 0; list-style: none; }
    .info-rules li { font-size: 12px; color: #742a2a; margin-bottom: 6px; display: flex; align-items: center; }
    .dot { width: 18px; height: 18px; background: #feb2b2; color: white; font-size: 10px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px; flex-shrink: 0; }

    /* BANCOS E DADOS */
    .bank-option-btn { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #e2e8f0; background: white; font-weight: 600; display: flex; align-items: center; gap: 12px; color: #2d3748; }
    .bank-option-btn.active { border-color: var(--blue); background: #f0f7ff; color: var(--blue); }
    .info-group { margin-bottom: 15px; }
    .info-group label { font-size: 11px; color: #718096; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; display: block; }
    .copyable-input, .copy-box input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 13px; font-weight: 600; color: #1a202c; }
    .copy-box { display: flex; gap: 5px; }
    .copy-box button { background: var(--blue); color: white; border: none; padding: 0 15px; border-radius: 8px; }
    .value-highlight input { background: #f0fff4; border: 1px solid #c6f6d5; color: var(--green); font-size: 16px; text-align: center; }

    /* UPLOAD */
    .upload-box { border: 2px dashed #cbd5e0; border-radius: 12px; padding: 25px; text-align: center; background: #f7fafc; cursor: pointer; }
    .upload-box i { font-size: 30px; color: var(--blue); margin-bottom: 10px; display: block; }
    .simple-input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f1f5f9; outline: none; }

    /* BOTÕES */
    .btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--blue); color: white; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 10px; }
    .btn-main:disabled { background: #e2e8f0; color: #a0aec0; cursor: not-allowed; }
    .btn-final { background: var(--green); box-shadow: 0 4px 10px rgba(46,125,50,0.2); }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const manualInput = document.getElementById('manual-amount');
        const amountHidden = document.getElementById('id_amount');
        const methodHidden = document.getElementById('id_payment_method');
        const next1 = document.getElementById('to-step-2');
        const next2 = document.getElementById('to-step-3');

        // Sincroniza valor do Passo 1
        manualInput.addEventListener('input', (e) => {
            const val = e.target.value;
            amountHidden.value = val;
            next1.disabled = (val <= 0 || val === "");
            updateFinalDisplay();
        });

        // Troca de Método
        document.querySelectorAll('.method-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.method-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                methodHidden.value = card.dataset.method;
                document.getElementById('currency-label').innerText = card.dataset.curr;
                updateFinalDisplay();
            });
        });

        function updateFinalDisplay() {
            const val = manualInput.value || "0.00";
            const curr = document.getElementById('currency-label').innerText;
            document.querySelectorAll('.display-final-amount').forEach(el => el.value = val + " " + curr);
        }

        // Navegação de Passos
        next1.addEventListener('click', () => goToStep(2));

        document.querySelectorAll('.bank-option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.bank-option-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('id_selected_bank').value = btn.dataset.bankId;
                next2.disabled = false;
            });
        });

        next2.addEventListener('click', () => {
            const bankId = document.getElementById('id_selected_bank').value;
            document.querySelectorAll('.bank-info-card').forEach(c => c.style.display = 'none');
            document.getElementById('details-' + bankId).style.display = 'block';
            goToStep(3);
        });

        document.getElementById('to-step-4').addEventListener('click', () => goToStep(4));

        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            document.getElementById('step-' + step).style.display = 'block';
            
            // Atualiza Stepper Visual
            if(step >= 2) {
                document.getElementById('circle-1').classList.add('checked');
                document.getElementById('circle-1').innerHTML = "✓";
                document.getElementById('circle-2').classList.add('active');
            }
            if(step >= 4) {
                document.getElementById('circle-2').classList.add('checked');
                document.getElementById('circle-2').innerHTML = "✓";
                document.getElementById('circle-3').classList.add('active');
            }
            window.scrollTo(0,0);
        }

        document.getElementById('file-upload').addEventListener('change', function() {
            const name = this.files[0] ? this.files[0].name : "Selecionar arquivo";
            document.getElementById('file-name').innerText = name;
        });

        // Validação Final
        document.getElementById('deposit-form').onsubmit = function(e) {
            const file = document.getElementById('file-upload').files[0];
            const payer = document.getElementById('id_payer_name').value;
            if (!file || !payer) {
                alert("Atenção: Anexe o comprovativo e informe o nome do depositante.");
                return false;
            }
        };
    });

    function copyText(id) {
        const input = document.getElementById(id);
        input.select();
        navigator.clipboard.writeText(input.value);
        alert("Copiado com sucesso!");
    }
</script>
{% endblock %}
