{% extends "base.html" %}
{% load static %}

{% block title %}Depósito - TotalEnergies{% endblock %}

{% block content %}
<div class="deposit-container">
    <div class="jackpay-header">
        <div class="logo-box">
            <i class="fas fa-shield-alt"></i> <span>JackPay Security</span>
        </div>
    </div>

    <div class="stepper">
        <div class="step-item" id="step-dot-1">
            <div class="circle active">1</div>
            <span>Método</span>
        </div>
        <div class="line"></div>
        <div class="step-item" id="step-dot-2">
            <div class="circle" id="circle-2">2</div>
            <span>Dados</span>
        </div>
        <div class="line"></div>
        <div class="step-item" id="step-dot-3">
            <div class="circle" id="circle-3">3</div>
            <span>Envio</span>
        </div>
    </div>

    {% if deposit_success %}
        <div class="success-screen">
            <div class="success-icon"><i class="fas fa-check"></i></div>
            <h2>Solicitação Enviada!</h2>
            <p>O seu depósito será confirmado em nossa conta em um período de 5 a 30 minutos.</p>
            <a href="{% url 'home' %}" class="btn-main">Voltar ao Início</a>
        </div>
    {% else %}
        <form id="deposit-form" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <input type="hidden" name="amount" id="id_amount">
            <input type="hidden" name="payment_method" id="id_payment_method" value="bank">
            <input type="hidden" name="selected_bank" id="id_selected_bank">

            <div id="step-1" class="step-content">
                <div class="balance-card">
                    <p><i class="fas fa-wallet"></i> Saldo Disponível</p>
                    <h3>Kz {{ user.available_balance|default:"0.00" }}</h3>
                </div>

                <div class="amount-section">
                    <label>Valor do Depósito</label>
                    <div class="input-wrapper">
                        <span class="currency-tag" id="currency-label">Kz</span>
                        <input type="number" id="manual-amount" placeholder="0.00">
                    </div>

                    <p class="label-small">Escolha o Método de Pagamento</p>
                    <div class="method-grid">
                        <div class="method-card active" data-method="bank" data-curr="Kz">
                            <i class="fas fa-university"></i>
                            <span class="method-name">Banco</span>
                        </div>
                        <div class="method-card" data-method="pix" data-curr="R$">
                            <i class="fas fa-bolt"></i>
                            <span class="method-name">PIX</span>
                        </div>
                        <div class="method-card" data-method="trc20" data-curr="USDT">
                            <i class="fas fa-coins"></i>
                            <span class="method-name">USDT</span>
                        </div>
                    </div>
                </div>

                <div class="info-rules">
                    <h4><i class="fas fa-info-circle"></i> Regras de Depósito</h4>
                    <ul id="rules-list">
                        <li><span class="dot">1</span> Valor mínimo: 10.000 Kz / 50 R$ / 10 USDT.</li>
                        <li><span class="dot">2</span> Use apenas dados oficiais indicados aqui.</li>
                        <li><span class="dot">3</span> Anexe o comprovativo original.</li>
                    </ul>
                </div>
                
                <button type="button" class="btn-main" id="to-step-2" disabled>Continuar</button>
            </div>

            <div id="step-2" class="step-content" style="display: none;">
                <h4 class="step-title">Selecione a conta de destino</h4>
                <div class="bank-list">
                    {% for bank in platform_bank_details %}
                        <button type="button" class="bank-option-btn" data-bank-id="{{ forloop.counter }}">
                            <i class="fas fa-university"></i> {{ bank.bank_name }}
                        </button>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main" id="to-step-3" style="margin-top:20px" disabled>Ver Dados de Pagamento</button>
            </div>

            <div id="step-3" class="step-content" style="display: none;">
                <div class="bank-details-wrapper">
                    {% for bank in platform_bank_details %}
                        <div id="details-{{ forloop.counter }}" class="bank-info-card" style="display: none;">
                            <div class="info-group">
                                <label>Destino</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.bank_name }}" readonly>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>Titular</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.account_holder_name }}" readonly>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>IBAN / Carteira</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.IBAN }}" id="iban-{{ forloop.counter }}" readonly>
                                    <button type="button" class="copy-btn" onclick="copyText('iban-{{ forloop.counter }}')"><i class="far fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>Valor a Enviar</label>
                                <div class="copy-input highlight">
                                    <input type="text" class="display-final-amount" readonly style="font-weight: bold; color: #2e7d32;">
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main" id="to-step-4" style="margin-top:20px">Já realizei o pagamento</button>
            </div>

            <div id="step-4" class="step-content" style="display: none;">
                <p class="upload-label">Anexe o comprovativo abaixo</p>
                <div class="upload-box" onclick="document.getElementById('file-upload').click()">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <input type="file" name="proof_of_payment" id="file-upload" hidden accept="image/*">
                    <p id="file-name" style="font-size: 13px; color: #2d3436; font-weight: 600;"></p>
                    <p style="font-size: 11px; color: #999;">Clique para selecionar arquivo</p>
                </div>
                
                <div class="info-group" style="margin-top: 20px;">
                    <label>Nome do Depositante / ID Transação</label>
                    <input type="text" name="payer_name" id="id_payer_name" placeholder="Ex: João Silva ou Hash" class="simple-input">
                </div>

                <button type="submit" class="btn-main" id="final-submit" style="background: #2e7d32; margin-top: 20px;">Finalizar Depósito</button>
            </div>
        </form>
    {% endif %}
</div>

<style>
    :root { --total-blue: #0056b3; --total-green: #2e7d32; --bg-white: #ffffff; }
    html, body { background-color: var(--bg-white) !important; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
    .deposit-container { width: 100%; max-width: 500px; margin: 0 auto; padding: 15px; }
    
    .jackpay-header { text-align: center; margin-bottom: 25px; }
    .logo-box { background: #f1f2f6; padding: 8px 25px; display: inline-flex; align-items: center; gap: 10px; border-radius: 50px; font-weight: 800; color: var(--total-blue); border: 1px solid #dcdde1; }
    
    .stepper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
    .step-item { text-align: center; flex: 1; }
    .circle { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #dfe6e9; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; color: #b2bec3; font-weight: bold; }
    .circle.active { border-color: var(--total-blue); color: var(--total-blue); background: #eef2ff; }
    .circle.checked { background: var(--total-blue); color: white; border-color: var(--total-blue); }
    .line { flex: 0.5; height: 2px; background: #dfe6e9; margin-top: -15px; }

    .balance-card { background: linear-gradient(135deg, var(--total-blue), #003d82); color: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; }
    .method-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .method-card { border: 1px solid #eee; padding: 15px 5px; border-radius: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
    .method-name { font-size: 11px; font-weight: 700; margin-top: 5px; display: block; color: #636e72; }
    .method-card.active { border-color: var(--total-blue); background: #f0f7ff; }
    .method-card.active .method-name { color: var(--total-blue); }
    
    .amount-section { background: #fff; border: 1px solid #dfe6e9; border-radius: 15px; padding: 15px; }
    .input-wrapper { display: flex; align-items: center; background: #f8f9fa; border: 2px solid #eee; border-radius: 10px; padding: 10px; margin: 10px 0; }
    .currency-tag { font-weight: bold; color: var(--total-blue); border-right: 1px solid #ddd; padding-right: 10px; }
    .input-wrapper input { border: none; background: transparent; outline: none; width: 100%; padding-left: 10px; font-size: 18px; font-weight: 600; }

    .bank-option-btn { width: 100%; padding: 16px; margin-bottom: 10px; background: #fff; border: 1px solid #eee; border-radius: 12px; font-weight: 600; text-align: left; }
    .bank-option-btn.active { border: 2px solid var(--total-blue); background: #f0f7ff; }

    .copy-input { display: flex; align-items: center; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; }
    .copy-input input { border: none; padding: 12px; flex: 1; outline: none; font-size: 13px; background: transparent; }
    .copy-btn { background: #dfe6e9; border: none; padding: 12px 15px; color: var(--total-blue); cursor: pointer; }
    .highlight { border: 1px solid var(--total-green); background: #e8f5e9; }

    .upload-box { border: 2px dashed #b2bec3; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; }
    .simple-input { width: 100%; border: 1px solid #eee; border-radius: 10px; padding: 14px; background: #f8f9fa; }
    .btn-main { width: 100%; background: var(--total-blue); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; }
    .btn-main:disabled { background: #dfe6e9; color: #b2bec3; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const manualInput = document.getElementById('manual-amount');
        const amountHidden = document.getElementById('id_amount');
        const methodHidden = document.getElementById('id_payment_method');
        const next1 = document.getElementById('to-step-2');
        const next2 = document.getElementById('to-step-3');

        // Validação de Valor no Passo 1
        manualInput.addEventListener('input', (e) => {
            amountHidden.value = e.target.value;
            next1.disabled = (e.target.value <= 0 || e.target.value === "");
            updateFinalDisplay();
        });

        // Seleção de Métodos (Texto sempre visível via CSS .method-name)
        document.querySelectorAll('.method-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.method-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                methodHidden.value = card.dataset.method;
                document.getElementById('currency-label').innerText = card.dataset.curr;
                updateFinalDisplay();
            });
        });

        function updateFinalDisplay() {
            const val = manualInput.value || "0.00";
            const curr = document.getElementById('currency-label').innerText;
            document.querySelectorAll('.display-final-amount').forEach(el => el.value = val + " " + curr);
        }

        // Navegação
        next1.addEventListener('click', () => goToStep(2));

        document.querySelectorAll('.bank-option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.bank-option-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('id_selected_bank').value = btn.dataset.bankId;
                next2.disabled = false;
            });
        });

        next2.addEventListener('click', () => {
            const bankId = document.getElementById('id_selected_bank').value;
            document.querySelectorAll('.bank-info-card').forEach(c => c.style.display = 'none');
            document.getElementById('details-' + bankId).style.display = 'block';
            goToStep(3);
        });

        document.getElementById('to-step-4').addEventListener('click', () => goToStep(4));

        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            document.getElementById('step-' + step).style.display = 'block';
            if(step >= 2) document.getElementById('circle-2').classList.add('active');
            if(step >= 4) {
                const c3 = document.getElementById('circle-3');
                c3.classList.add('active');
                const c2 = document.getElementById('circle-2');
                c2.classList.add('checked');
                c2.innerHTML = "✓";
            }
            window.scrollTo(0,0);
        }

        document.getElementById('file-upload').addEventListener('change', function() {
            document.getElementById('file-name').innerText = this.files[0] ? this.files[0].name : "";
        });

        // Validação final antes de enviar para evitar erro de console
        document.getElementById('deposit-form').onsubmit = function(e) {
            const file = document.getElementById('file-upload').files[0];
            const payer = document.getElementById('id_payer_name').value;
            if (!file || !payer) {
                alert("Por favor, anexe o comprovativo e digite seu nome.");
                return false;
            }
        };
    });

    function copyText(id) {
        const input = document.getElementById(id);
        input.select();
        navigator.clipboard.writeText(input.value);
        alert("Copiado!");
    }
</script>
{% endblock %}
